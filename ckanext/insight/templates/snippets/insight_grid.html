{# Snippet: grid insight modern + AOS (Animate On Scroll) #}
{% set _title = title|default('Data Insight') %}
{% set _limit = limit|default(7) %}
{% set _order = order|default('count_desc') %}
{% set _q     = q|default('') %}
{% set _more  = show_more_url|default(h.url_for('ckanet_insight.insights_home')) %}
{% set _groups = h.ckanet_insight_list(_limit, _order, _q) %}

<style>
  /* ==== Design tokens ==== */
  .ins-section{ --ins-gap:14px; --ins-radius:14px; --ins-shadow:0 6px 24px rgba(0,0,0,.08);
    --ins-card-bg:#fff; --ins-border:#e9edf2; --ins-text:#1c2330; --ins-muted:#637083; --ins-primary:#0b5ed7; --ins-chip-bg:#eef5ff; --ins-chip-bd:#dbe8ff; }
  @media (prefers-color-scheme: dark){
    .ins-section{ --ins-card-bg:#14171f; --ins-border:#273042; --ins-text:#e8edf5; --ins-muted:#a6b2c2; --ins-shadow:0 10px 30px rgba(0,0,0,.35); --ins-chip-bg:#13233b; --ins-chip-bd:#1e3354; }
  }

  .ins-section .ins-header{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
    background: linear-gradient(90deg, rgba(11,94,215,.10), transparent);
    padding:8px 10px; border-radius:12px;
  }
  .ins-section .ins-header .module-heading{ margin:0; font-weight:700; letter-spacing:.2px; }

  .ins-section .btn-ghost{
    border:1px solid var(--ins-border); background:transparent; color:var(--ins-text);
    padding:6px 10px; border-radius:10px; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
  }
  .ins-section .btn-ghost:hover{ border-color:var(--ins-primary); color:var(--ins-primary); }

  .ins-grid{ display:grid; gap:var(--ins-gap); grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); }
  @media (max-width:520px){ .ins-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); } }

  .ins-card{
    background:var(--ins-card-bg); border:1px solid var(--ins-border); border-radius:var(--ins-radius);
    overflow:hidden; display:flex; flex-direction:column; text-decoration:none; color:inherit;
    transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease; will-change: transform, box-shadow;
  }
  .ins-card:hover{ transform:translateY(-2px); box-shadow:var(--ins-shadow); border-color:rgba(11,94,215,.35); }

  /* Media: ratio 16:9 dengan fallback */
  .ins-media{ position:relative; background:#f6f8fb; }
  .ins-media{ aspect-ratio:16/9; }
  @supports not (aspect-ratio: 16 / 9){
    .ins-media::before{ content:""; display:block; padding-top:56%; }
  }
  .ins-media > *{ position:absolute; inset:0; }
  .ins-img{ width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .25s ease; }
  .ins-img.is-ready{ opacity:1; }
  .ins-ph{ display:flex; align-items:center; justify-content:center; font-size:44px; color:#b9c3d1; background:#f6f8fb; }
  .ins-chip{
    position:absolute; top:10px; left:10px; border:1px solid var(--ins-chip-bd);
    color:var(--ins-primary); border-radius:999px; padding:4px 10px; font-size:12px; line-height:1;
  }

  .ins-body{ padding:12px 12px 14px; display:flex; flex-direction:column; gap:6px; }
  .ins-title{ font-size:15px; font-weight:700; color:var(--ins-text); line-height:1.25;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .ins-desc{ font-size:12px; color:var(--ins-muted); 
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

  .ins-empty{ color:var(--ins-muted); text-align:center; padding:10px 0 0; }
</style>

<div class="module ins-section" id="insight-grid-section">
  <div class="module-content">
    <h2 class="text-center mb-4" data-aos="fade-up"><i class="fas fa-id-card"></i> Data Insight</h2>
    <div class="ins-header" data-aos="fade-up" data-aos-delay="80">
      <!-- <h3 class="module-heading">{{ _title }}</h3> -->
      <a class="btn-ghost" href="{{ _more }}">Lihat semua <i class="fa fa-arrow-right"></i></a>
    </div>

    {% if not _groups %}
      <p class="ins-empty" data-aos="fade-up" data-aos-delay="120">Belum ada insight untuk ditampilkan.</p>
    {% else %}
      <div class="ins-grid">
        {% for g in _groups %}
          {# Staggered delay: 0,60,120,... #}
          {% set _delay = (loop.index0 % 6) * 60 %}
          <a class="ins-card" href="{{ h.url_for('group.read', id=g.name) }}"
             aria-label="Buka grup {{ g.title }}"
             data-aos="fade-up" data-aos-delay="{{ _delay }}" data-aos-duration="650">
            <div class="ins-media">
              {% if g.image_url %}
                <img class="ins-img" loading="lazy" src="{{ g.image_url }}" alt="{{ g.title }}">
              {% else %}
                <div class="ins-ph"><i class="fa fa-folder-open"></i></div>
              {% endif %}
              <span class="ins-chip">{{ g.package_count }} dataset{% if g.package_count != 1 %}s{% endif %}</span>
            </div>
            <div class="ins-body">
              <div class="ins-title" title="{{ g.title }}"><span class="ins-extra">Data </span>{{ g.title }}</div>
              <!--{% if g.description %}<div class="ins-desc">{{ g.description }}</div>{% endif %}-->
            </div>
          </a>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Lazy-image fade-in + refresh AOS setelah gambar siap
  (function(){
    var root = document.getElementById('insight-grid-section');
    if(!root) return;
    var imgs = root.querySelectorAll('.ins-img');
    var pending = imgs.length;
    function onOneReady(img){
      img.classList.add('is-ready');
      if (typeof AOS !== 'undefined') { AOS.refresh(); }
    }
    imgs.forEach(function(img){
      if (img.complete && img.naturalWidth) { onOneReady(img); return; }
      img.addEventListener('load', function(){ onOneReady(img); }, {once:true});
      img.addEventListener('error', function(){
        var ph = document.createElement('div');
        ph.className = 'ins-ph';
        ph.innerHTML = '<i class="fa fa-folder-open"></i>';
        img.replaceWith(ph);
        if (typeof AOS !== 'undefined') { AOS.refresh(); }
      }, {once:true});
    });
  })();

  // Load AOS (CSS/JS) sekali saja, lalu init
  (function(){
    function ensureCss(href){
      if ([].some.call(document.styleSheets, function(s){ return (s.href||'').indexOf('aos') !== -1; })) return;
      var l = document.createElement('link');
      l.rel = 'stylesheet'; l.href = 'https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css';
      document.head.appendChild(l);
    }
    function ensureJs(cb){
      if (window.AOS){ cb(); return; }
      var s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js';
      s.onload = cb;
      document.head.appendChild(s);
    }
    ensureCss();
    ensureJs(function(){
      // Init AOS
      AOS.init({
        duration: 600,
        easing: 'ease-out-cubic',
        once: false,
        mirror: true,
        offset: 60,
        anchorPlacement: 'top-bottom'
      });
      // Refresh setelah load fonts/resize
      window.addEventListener('load', function(){ AOS.refresh(); });
      window.addEventListener('resize', function(){ AOS.refresh(); });
    });
  })();
</script>
